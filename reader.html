<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RUMIB EPUB 뷰어</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Nanum Gothic', sans-serif;
      background: #fff0f5;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: #222;
      color: #fff;
    }
    h1 { text-align: center; color: #d6336c; margin-top: 1rem; }
    #controls, #viewerControls {
      text-align: center; margin: 0.5rem 0;
    }
    button, select, input[type=color] {
      margin: 0.2rem;
      padding: 0.4rem 0.8rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
    }
    #viewer {
      width: 90vw;
      height: 80vh;
      border: 1px solid #ccc;
      background: white;
    }
    .popup {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 1rem;
      border: 2px solid #ffc0cb;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      width: 300px;
    }
    .popup h3 { margin-top: 0; }
    .popup ul { list-style: none; padding: 0; }
    .popup li {
      padding: 0.3rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }
    .popup li:hover { background: #ffd3e0; }
    .closeBtn {
      float: right;
      cursor: pointer;
      color: red;
    }
  </style>
</head>
<body>
  <h1>📚 RUMIB EPUB 뷰어</h1>
  <div id="controls">
    <input type="file" id="fileInput" accept=".epub" />
  </div>
  <div id="viewerControls" style="display:none">
    <button onclick="toggleTheme()">🌞/🌙 다크모드</button>
    <button onclick="changeFontSize(-2)">A-</button>
    <button onclick="changeFontSize(2)">A+</button>
    <select onchange="changeFont(this.value)">
      <option value="'Nanum Gothic', sans-serif">나눔고딕</option>
      <option value="'Noto Serif KR', serif">Noto Serif KR</option>
      <option value="'Arial', sans-serif">Arial</option>
      <option value="'Georgia', serif">Georgia</option>
    </select>
    <label>글자색 <input type="color" id="fontColor" value="#000000" onchange="updateTheme()"></label>
    <label>배경색 <input type="color" id="bgColor" value="#fff0f5" onchange="updateTheme()"></label>
    <select id="marginSelect" onchange="updateTheme()">
      <option value="1rem">보통 여백</option>
      <option value="0.5rem">좁게</option>
      <option value="0rem">없음</option>
    </select>
    <button onclick="prevPage()">← 이전</button>
    <button onclick="nextPage()">다음 →</button>
    <button onclick="saveBookmark()">🔖 북마크 저장</button>
    <button onclick="showPopup('bookmarkPopup')">📑 북마크 목록</button>
    <button onclick="showPopup('notePopup')">📝 메모 목록</button>
    <button onclick="showPopup('tocPopup')">📚 목차</button>
  </div>

  <div id="bookmarkPopup" class="popup" style="display:none">
    <span class="closeBtn" onclick="hidePopup('bookmarkPopup')">❌</span>
    <h3>📑 북마크 목록</h3>
    <ul id="bookmarkItems"></ul>
  </div>
  <div id="notePopup" class="popup" style="display:none">
    <span class="closeBtn" onclick="hidePopup('notePopup')">❌</span>
    <h3>📝 메모 목록</h3>
    <ul id="noteItems"></ul>
  </div>
  <div id="tocPopup" class="popup" style="display:none">
    <span class="closeBtn" onclick="hidePopup('tocPopup')">❌</span>
    <h3>📚 목차</h3>
    <ul id="tocItems"></ul>
  </div>

  <div id="viewer"></div>

  <script>
    let book, rendition;
    const viewerControls = document.getElementById("viewerControls");
    const viewer = document.getElementById("viewer");

    document.getElementById("fileInput").addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);

      if (rendition) {
        rendition.destroy();
        viewer.innerHTML = "";
      }

      book = ePub(url);
      rendition = book.renderTo("viewer", {
        width: "100%",
        height: "100%",
      });

      rendition.display();
      viewerControls.style.display = "block";

      const themeColors = document.body.classList.contains("dark") ? { background: "#222", color: "#fff" } : { background: "#fff", color: "#000" };
      rendition.themes.default({ body: themeColors });

      book.loaded.navigation.then(nav => {
        const tocItems = document.getElementById("tocItems");
        tocItems.innerHTML = "";
        nav.toc.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item.label;
          li.addEventListener("click", () => {
            rendition.display(item.href);
            hidePopup("tocPopup");
          });
          tocItems.appendChild(li);
        });
      });

      rendition.on("selected", function (cfiRange, contents) {
        const note = prompt("메모를 입력하세요");
        if (note) {
          localStorage.setItem(`note_${cfiRange}`, note);
          const item = document.createElement("li");
          item.textContent = note;
          const del = document.createElement("button");
          del.textContent = "❌";
          del.onclick = function () {
            localStorage.removeItem(`note_${cfiRange}`);
            item.remove();
          };
          item.appendChild(del);
          item.addEventListener("click", function () {
            rendition.display(cfiRange);
            hidePopup("notePopup");
          });
          document.getElementById("noteItems").appendChild(item);
        }
      });
    });

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const themeColors = document.body.classList.contains("dark") ? { background: "#222", color: "#fff" } : { background: "#fff", color: "#000" };
      if (rendition) {
        rendition.themes.default({ body: themeColors });
      }
    }
    function showPopup(id) {
      document.getElementById(id).style.display = "block";
    }
    function hidePopup(id) {
      document.getElementById(id).style.display = "none";
    }
    function prevPage() {
      rendition.prev();
    }
    function nextPage() {
      rendition.next();
    }
    function changeFontSize(amount) {
      const iframe = document.querySelector("#viewer iframe");
      if (iframe && iframe.contentDocument && iframe.contentDocument.body) {
        const body = iframe.contentDocument.body;
        const currentSize = parseInt(window.getComputedStyle(body).fontSize);
        body.style.fontSize = (currentSize + amount) + "px";
      }
    }
    function changeFont(font) {
      if (rendition) {
        rendition.themes.font(font);
      }
    }
    function updateTheme() {
      const fontColor = document.getElementById("fontColor").value;
      const bgColor = document.getElementById("bgColor").value;
      const margin = document.getElementById("marginSelect").value;
      if (rendition) {
        rendition.themes.override("color", fontColor);
        rendition.themes.override("background", bgColor);
        rendition.themes.default({ body: { padding: margin } });
      }
    }
    function saveBookmark() {
      if (rendition && rendition.currentLocation()) {
        const cfi = rendition.currentLocation().start.cfi;
        const key = `bookmark_${cfi}`;
        if (localStorage.getItem(key)) return;
        localStorage.setItem(key, true);
        const item = document.createElement("li");
        item.textContent = `북마크: ${cfi}`;
        const del = document.createElement("button");
        del.textContent = "❌";
        del.onclick = function () {
          localStorage.removeItem(key);
          item.remove();
        };
        item.appendChild(del);
        item.addEventListener("click", function () {
          rendition.display(cfi);
          hidePopup("bookmarkPopup");
        });
        document.getElementById("bookmarkItems").appendChild(item);
      }
    }
  </script>
</body>
</html>
